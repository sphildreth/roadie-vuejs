<template>
  <div class="release-detail-container">
    <Toolbar
      :menuItems="menuItems"
      :adminItems="adminMenuItems"
      :searchItems="seachMenuItems"
      :toolbarIcon="'music_video'"
      :doShowBookmark="true"
      :bookmarked="release.userBookmarked"
      :doShowFavorite="true"
      :favorited="release.userRating && release.userRating.isFavorite"
      :doShowHated="true"
      :hated="release.userRating && release.userRating.isDisliked"
    ></Toolbar>
    <v-container v-if="!loading && !showMergingRelease && coverSearchItems.length === 0" fluid grid-list-md>
      <v-layout row wrap>
        <v-flex xs12 sm7 md7>
          <v-layout row wrap>
            <v-flex xs12>
              <v-card color="primary" class="profile darken-1">
                <v-card-text
                  class="title"
                  :class="{ 'playing-release': this.$store.getters.playingIndex.releaseId == release.id }"
                >
                  {{ release.title }}
                  <v-icon
                    v-if="release.isLocked"
                    style="float: right;"
                    title="Release is locked!"
                    color="warning"
                  >lock</v-icon>
                  <v-icon
                    v-if="release.status > 2"
                    style="float: right;"
                    title="Release has issues!"
                    color="warning"
                  >warning</v-icon>
                </v-card-text>
              </v-card>
            </v-flex>
            <v-flex xs12>
              <v-layout row wrap>
                <v-flex xs12 md3>
                  <v-img :src="releaseCoverUrl" :alt="release.title" class="ma-1" aspect-ratio="1"></v-img>
                  <img id="releaseImage" :src="releaseCoverUrl" style="display:none;">
                </v-flex>
                <v-flex xs12 md9 class="title">
                  <v-layout row wrap>
                    <v-flex xs12 md5 class="mt-3">
                      <ArtistCard :artist="release.artist"></ArtistCard>
                    </v-flex>
                  </v-layout>
                  <v-layout row wrap>
                    <v-flex xs4>
                      <v-text-field
                        v-bind:value="release.releaseDate | shortDate"
                        label="Release Date"
                        readonly
                      ></v-text-field>
                    </v-flex>
                    <v-flex xs4>
                      <v-text-field v-bind:value="release.mediaCount" label="Media Count" readonly></v-text-field>
                    </v-flex>
                    <v-flex xs4>
                      <v-text-field v-bind:value="release.trackCount" label="Track Count" readonly></v-text-field>
                    </v-flex>                 
                  </v-layout>
                  <v-layout row wrap>
                    <v-flex xs4>
                      <v-text-field
                        v-bind:value="release.releaseType"
                        label="Release Type"
                        readonly
                      ></v-text-field>
                    </v-flex>
                    <v-flex xs4>
                      <v-text-field
                        v-bind:value="release.statusVerbose"
                        label="Release Status"
                        readonly
                      ></v-text-field>
                    </v-flex>
                    <v-flex xs4 v-if="release.rank">
                      <v-text-field v-bind:value="release.rank + ' (#' + release.rankPosition + ')'" title="Calculated Rank (# Position)" label="Rank" readonly></v-text-field>
                    </v-flex>                      
                  </v-layout>
                </v-flex>
              </v-layout>
            </v-flex>
          </v-layout>
        </v-flex>
        <v-flex d-flex xs12 sm5 md5>
          <v-tabs right color="primary" v-model="tab" slider-color="accent">
            <v-tab v-if="release.images.length">Images</v-tab>
            <v-tab v-if="release.profile">Profile</v-tab>
            <v-tab>Metadata Sources</v-tab>
            <v-tab-item v-if="release.images.length">
              <v-card flat class="images darken-3">
                <v-container class="images-container" fluid grid-list-xs>
                  <v-layout row wrap>
                    <v-flex v-for="(image, index) in release.images" :key="image.url" xs2>
                      <v-img
                        :src="image.thumbnailUrl"
                        class="grey lighten-2"
                        @click="showImageModal(release.images[index])"
                        :data-id="index"                        
                        @contextmenu="show"                        
                      ></v-img>
                    </v-flex>
                  </v-layout>
                  <v-menu
                    v-model="showImageMenu"
                    :position-x="imageMenuX"
                    :position-y="imageMenuY"
                    absolute
                    offset-y
                  >
                    <v-list>
                      <v-list-tile
                        v-for="(item, index) in imageMenuItems"
                        :key="index"
                        @click="imageMenuClicked(index)"
                      >
                        <v-list-tile-title>{{ item.title }}</v-list-tile-title>
                      </v-list-tile>
                    </v-list>
                  </v-menu>                   
                  <v-dialog v-model="showModal" content-class="modal-image-container">
                    <v-card @click="showModal = !showModal">
                      <v-card-title class="headline">{{ modalImage.caption}}</v-card-title>
                      <v-card-text class="grey">
                        <img
                          style="max-height:800px;"
                          class="modal-image"
                          v-bind:src="modalImage.url"
                          v-bind:title="modalImage.caption"
                          v-bind:alt="modalImage.caption"
                        >
                      </v-card-text>
                    </v-card>
                  </v-dialog>
                </v-container>
              </v-card>
            </v-tab-item>
            <v-tab-item v-if="release.profile">
              <v-card flat class="profile darken-3 pa-2">
                <vue-markdown>{{release.profile}}</vue-markdown>
              </v-card>
            </v-tab-item>
            <v-tab-item>
              <v-data-table
                :headers="metaDataHeaders"
                :items="metaDataSources()"
                class="elevation-1"
                hide-actions
              >
                <template slot="items" slot-scope="props">
                  <td v-if="props.item.sourceId">{{ props.item.source }}</td>
                  <td v-if="props.item.sourceId">
                    <a
                      v-bind:href="props.item.url + props.item.sourceId"
                      target="_blank"
                    >{{ props.item.sourceId }}</a>
                  </td>
                </template>
              </v-data-table>
            </v-tab-item>
          </v-tabs>
        </v-flex>
      </v-layout>
      <v-layout row wrap>
        <v-flex d-flex xs12>
          <div class="stats-container">
            <v-tooltip bottom>
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-rating
                  @click.native="setRating"
                  @change.native="setRating"
                  v-model="userRating.rating"
                  class="pointer release-rating"
                  background-color="orange lighten-3"
                  color="orange"
                  medium
                  dense
                  hover
                  clearable
                ></v-rating>
              </v-chip>
              <span>Rate Release</span>
            </v-tooltip>
            <v-tooltip bottom>
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>stars</v-icon>
                </v-avatar>
                <v-rating
                  v-model="release.rating"
                  background-color="orange lighten-3"
                  color="orange"
                  readonly
                  small
                  dense
                ></v-rating>
              </v-chip>
              <span>Release Average Rating</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>album</v-icon>
                </v-avatar>
                {{ release.statistics.mediaCount | padNumber4 }}
              </v-chip>
              <span>Release Medias</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>audiotrack</v-icon>
                </v-avatar>
                {{ release.statistics.trackCount | padNumber4 }}
              </v-chip>
              <span>Release Tracks</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>play_circle_outline</v-icon>
                </v-avatar>
                {{ release.statistics.trackPlayedCount | padNumber5 }}
              </v-chip>
              <span>Release Played Count</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip
                v-if="release.statistics.missingTrackCount"
                slot="activator"
                color="warning"
                text-color="black"
              >
                <v-avatar>
                  <v-icon>error</v-icon>
                </v-avatar>
                {{ release.statistics.missingTrackCount }}
              </v-chip>
              <span>Release Tracks Missing</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>speaker</v-icon>
                </v-avatar>
                {{ release.statistics.trackTime }}
              </v-chip>
              <span>Release Track Playtime</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>folder_open</v-icon>
                </v-avatar>
                {{ release.statistics.trackSize }}
              </v-chip>
              <span>Release Media File Size</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>date_range</v-icon>
                </v-avatar>
                {{ release.createdDate | formatTimeStamp(this.$store.getters.user) }}
              </v-chip>
              <span>Release Created Date</span>
            </v-tooltip>
            <v-tooltip bottom class="hidden-sm-and-down">
              <v-chip slot="activator" color="secondary" text-color="white">
                <v-avatar>
                  <v-icon>update</v-icon>
                </v-avatar>
                {{ release.lastUpdated | formatTimeStamp(this.$store.getters.user) }}
              </v-chip>
              <span>Release Updated Date</span>
            </v-tooltip>
          </div>
        </v-flex>
      </v-layout>
      <v-layout row wrap>
        <v-flex d-flex xs12 md6>
          <v-tabs class="release-lists" color="primary" v-model="releaseTab" slider-color="accent">
            <v-tab>Tracks</v-tab>           
            <v-tab-item class="">
              <v-card flat class="tracks">
                <v-data-iterator
                  :items="release.medias"
                  :total-items="release.medias ? release.medias.length : 0"
                  content-tag="v-layout"
                  hide-actions
                  row
                  wrap
                >
                  <span class="pt-2">asdfasdfsadf</span>
                  <v-flex slot="item" slot-scope="props" xs12>
                    <MediaCard
                      :media="props.item"
                      :release="release"
                      :mediaCount="release.mediaCount"
                    ></MediaCard>
                  </v-flex>
                </v-data-iterator>
              </v-card>
            </v-tab-item>
          </v-tabs>
        </v-flex>
        <v-flex d-flex xs12 md6>
          <v-tabs class="release-lists" color="primary" slider-color="accent">
            <v-tab v-if="release.playlists.length > 0">Playlists</v-tab>
            <v-tab v-if="release.tagsList.length > 0">Tags</v-tab>
            <v-tab v-if="release.collections.length > 0">Collections</v-tab>
            <v-tab v-if="release.alternateNamesList.length">Alternate Names</v-tab>
            <v-tab v-if="release.genres.length">Genres</v-tab>
            <v-tab v-if="release.labels.length > 0">Labels</v-tab>
            <v-tab v-if="release.urLsList.length">Urls</v-tab>
            <v-tab class="hidden-md-and-down">{{'Comments' + ( release.comments.length > 0 ? ' (' + release.comments.length + ')' : '') }}</v-tab>                                              
            <v-tab-item v-if="release.playlists.length > 0">
              <v-card flat class="playlists">
                <v-data-iterator
                  :items="release.playlists"
                  :total-items="release.playlists ? release.playlists.length : 0"
                  content-tag="v-layout"
                  hide-actions
                  row
                  wrap
                >
                  <v-flex slot="item" slot-scope="props" xs12 md4>
                    <PlaylistCard :playlist="props.item"></PlaylistCard>
                  </v-flex>
                </v-data-iterator>
              </v-card>
            </v-tab-item>
            <v-tab-item v-if="release.tagsList.length > 0">
              <v-list>
                <template v-for="(name, index) in release.tagsList">
                  <v-list-tile :key="`t-${name}-${index}`">
                    <v-list-tile-content>
                      <v-list-tile-title>{{ name }}</v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>
                  <v-divider v-if="index + 1 < release.tagsList.length" :key="`tdivider-${index}`"></v-divider>
                </template>
              </v-list>
            </v-tab-item>
            <v-tab-item v-if="release.collections.length > 0">
              <v-card flat class="collections">
                <v-data-iterator
                  :items="release.collections"
                  :total-items="release.collections ? release.collections.length : 0"
                  content-tag="v-layout"
                  hide-actions
                  row
                  wrap
                >
                  <v-flex slot="item" slot-scope="props" xs12 lg6>
                    <CollectionCard
                      :collection="props.item.collection"
                      :listNumber="props.item.listNumber"
                    ></CollectionCard>
                  </v-flex>
                </v-data-iterator>
              </v-card>
            </v-tab-item>
            <v-tab-item v-if="release.alternateNamesList.length">
              <v-list>
                <template v-for="(name, index) in release.alternateNamesList">
                  <v-list-tile :key="`al-${name}-${index}`">
                    <v-list-tile-content>
                      <v-list-tile-title>{{ name }}</v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>
                  <v-divider
                    v-if="index + 1 < release.alternateNamesList.length"
                    :key="`adivider-${index}`"
                  ></v-divider>
                </template>
              </v-list>
            </v-tab-item>
            <v-tab-item v-if="release.genres.length">
              <v-list>
                <template v-for="(name, index) in release.genres">
                  <v-list-tile :key="`g-${name}-${index}`">
                    <v-list-tile-content>
                      <v-list-tile-title>{{ name.text }}</v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>
                  <v-divider v-if="index + 1 < release.genres.length" :key="`gdivider-${index}`"></v-divider>
                </template>
              </v-list>
            </v-tab-item>
            <v-tab-item v-if="release.labels.length > 0">
              <v-card flat class="labels">
                <v-data-iterator
                  :items="release.labels"
                  :total-items="release.labels ? release.labels.length : 0"
                  content-tag="v-layout"
                  hide-actions
                  row
                  wrap
                >
                  <v-flex slot="item" slot-scope="props" xs4>
                    <LabelCard
                      :label="props.item.label"
                      :catalogNumber="props.item.catalogNumber"
                      :beginDate="props.item.beginDate"
                      :endDate="props.item.endDate"
                    ></LabelCard>
                  </v-flex>
                </v-data-iterator>
              </v-card>
            </v-tab-item>
            <v-tab-item v-if="release.urLsList.length">
              <v-list>
                <template v-for="(name, index) in release.urLsList">
                  <v-list-tile :key="`u-${name}-${index}`">
                    <v-list-tile-content>
                      <v-list-tile-title>
                        <a v-bind:href="name" target="_blank">{{ name }}</a>
                      </v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>
                  <v-divider
                    v-if="index + 1 < release.urLsList.length"
                    :key="`uaadivider-${index}`"
                  ></v-divider>
                </template>
              </v-list>
            </v-tab-item>
            <v-tab-item class="hidden-md-and-down">
              <v-flex>
                <CommentCard :isNew="true" :addUrl="newCommentUrl"></CommentCard>
                <div v-if="release.comments.length > 0">
                  <hr class="ma-3"/>
                  <v-data-iterator
                    :items="release.comments"
                    :total-items="release.comments ? release.comments.length : 0"
                    content-tag="v-layout"
                    hide-actions
                    row
                    wrap
                  >
                    <v-flex slot="item" slot-scope="props" xs12>
                      <CommentCard :isNew="false" :isReadOnly="true" :comment="props.item"></CommentCard>
                    </v-flex>
                  </v-data-iterator>
                </div>
              </v-flex>              
            </v-tab-item>              

          </v-tabs>
        </v-flex>
      </v-layout>
    </v-container>
    <confirm ref="confirm"></confirm>
    <v-container v-if="!loading && !showMergingRelease && coverSearchItems.length > 0" fluid grid-list-md>
      <v-flex xs1 offset-xs11>
        <v-btn color="warning" @click="coverSearchItems = []">Cancel</v-btn>
      </v-flex>
      <v-text-field v-model="coverSearchQuery" label="Search Query"></v-text-field>
      <vue-dropzone
        ref="myVueDropzone"
        id="dropzone"
        v-on:vdropzone-complete="coverDragUploadComplete"
        :options="dropzoneOptions"
      ></vue-dropzone>
      <v-data-iterator
        v-if="coverSearchItems"
        :items="coverSearchItems"
        :total-items="coverSearchItems ? coverSearchItems.length : 0"
        content-tag="v-layout"
        hide-actions
        row
        wrap
      >
        <v-flex slot="item" slot-scope="props" xs1>
          <div>
            <v-img
              :src="props.item.mediaUrl"
              :alt="props.item.title"
              weight="80"
              class="ma-1 pointer"
              @click="selectedCoverImage(props.item.mediaUrl)"
            ></v-img>
          </div>
        </v-flex>
      </v-data-iterator>
    </v-container>
    <v-container v-if="!loading && showMergingRelease">
      <div>Select Release To Merge "{{ this.release.title }}" Release into</div>
      <v-layout row>
        <v-autocomplete
          :items="lookupData.releaseItems"
          v-model="selectedMergeRelease"
          :search-input.sync="searchForMergeRelease"
          :loading="searchReleasesLoading"
          label="Release"
          append-icon="fas fa-database"
          return-object
        ></v-autocomplete>
      </v-layout>
      <v-flex xs3>
        <v-btn color="warning" @click="showMergingRelease=false">Cancel</v-btn>
        <v-btn color="success" @click="doMerge()">Merge</v-btn>
      </v-flex>
    </v-container>
    <v-container v-if="loading">
        <v-progress-linear
          v-if="loading"
          height="2"
          color="accent"
          class="ma-0 pa-0"
          indeterminate
        ></v-progress-linear>
    </v-container>
  </div>
</template>

<script>
import Toolbar from "@/components/Toolbar";
import LabelCard from "@/components/LabelCard";
import ArtistCard from "@/components/ArtistCard";
import CollectionCard from "@/components/CollectionCard";
import PlaylistCard from "@/components/PlaylistCard";
import MediaCard from "@/components/MediaCard";
import CommentCard from "@/components/CommentCard";
import Confirm from "@/views/Confirm";
import { EventBus } from "@/event-bus.js";
import vue2Dropzone from "vue2-dropzone";
import "vue2-dropzone/dist/vue2Dropzone.min.css";
import VueMarkdown from "vue-markdown";
import releaseMixin from "@/mixins/release.js";
import trackMixin from "@/mixins/track.js";

export default {
  mixins: [releaseMixin, trackMixin],
  components: {
    Toolbar,
    LabelCard,
    ArtistCard,
    CollectionCard,
    CommentCard,        
    PlaylistCard,
    MediaCard,
    Confirm,
    vueDropzone: vue2Dropzone,
    'vue-markdown': VueMarkdown
  },
  props: {
    id: String
  },
  created() {
    EventBus.$on("rr:AddToQue", this.addToQue);
    EventBus.$on("rr:PlayNow", this.playNow);
    EventBus.$on("rr:searchInternetTitle", this.internetTitleSearch);
    EventBus.$on("rr:searchInternetArtist", this.internetArtistSearch);
    EventBus.$on(
      "rr:searchInternetreleaseandTitle",
      this.searchInternetreleaseandTitle
    );
    EventBus.$on("rr:searchForTitle", this.searchForTitle);
    EventBus.$on("rr:searchForArtist", this.searchForArtist);
    EventBus.$on("toolbarRefresh", this.updateData);
    EventBus.$on("bookmarkToogle", this.toggleBookmark);
    EventBus.$on("favoriteToogle", this.toggleFavorite);
    EventBus.$on("hateToogle", this.toggleHated);
    EventBus.$on("rr:Rescan", this.rescan);
    EventBus.$on("rr:Delete", this.delete);
    EventBus.$on("rr:DeleteFiles", this.deleteWithFiles);
    EventBus.$on("rr:MergeReleases", this.mergeReleases);
    EventBus.$on("rr:FindCover", this.findCover);
    EventBus.$on("rr:Edit", this.edit);
    this.debouncedFindCover = this.$_.debounce(this.findCover, 800);
    EventBus.$on("t:selected", track => this.addSelectedTrack(track));
    EventBus.$on("t:unselected", track => this.removeSelectedTrack(track));
    EventBus.$on("t:dislikeToggle", info => this.dislikeTrackToggle(info));
    EventBus.$on("t:favoriteToggle", info => this.favoriteTrackToggle(info));       
    EventBus.$on("userTrackRatingChange", info => this.updateIfNeeded(info));
    EventBus.$on("userTrackFavoriteChange",  info => this.updateIfNeeded(info));
    EventBus.$on("userTrackLikeChange", info => this.updateIfNeeded(info));
    EventBus.$on("addedComment", this.updateComments);
    EventBus.$on("deletedComment", this.updateComments);    
    this.debouncedMergeReleaseSearch = this.$_.debounce(
      this.doMergeReleaseSearch,
      500
    );
  },
  beforeDestroy() {
    EventBus.$off("rr:AddToQue", this.addToQue);
    EventBus.$off("rr:PlayNow", this.playNow);
    EventBus.$off("rr:searchInternetTitle");
    EventBus.$off("rr:searchInternetArtist");
    EventBus.$off("rr:searchInternetreleaseandTitle");
    EventBus.$off("rr:searchForArtist");
    EventBus.$off("rr:searchForTitle");
    EventBus.$off("toolbarRefresh");
    EventBus.$off("bookmarkToogle", this.toggleBookmark);
    EventBus.$off("favoriteToogle", this.toggleFavorite);
    EventBus.$off("hateToogle", this.toggleHated);
    EventBus.$off("rr:Rescan", this.rescan);
    EventBus.$off("rr:Delete", this.delete);
    EventBus.$off("rr:DeleteFiles", this.deleteWithFiles);
    EventBus.$off("rr:MergeReleases", this.mergeReleases);
    EventBus.$off("rr:FindCover", this.findCover);
    EventBus.$off("rr:Edit", this.edit);
    EventBus.$off("t:selected");
    EventBus.$off("t:unselected");
    EventBus.$off("t:dislikeToggle", info => this.dislikeTrackToggle(info));
    EventBus.$off("t:favoriteToggle", info => this.favoriteTrackToggle(info));      
    EventBus.$off("userTrackRatingChange");
    EventBus.$off("userTrackFavoriteChange");
    EventBus.$off("userTrackLikeChange");
    EventBus.$off("addedComment", this.updateComments);
    EventBus.$off("deletedComment", this.updateComments);    
  },
  async mounted() {
    this.updateData();
  },
  computed: {
    newCommentUrl() {
      return process.env.VUE_APP_API_URL + "/comments/add/release/" + this.release.id;
    },    
    searchQuery() {
      return this.release.title;
    },
    releaseCoverUrl() {
      return this.release.mediumThumbnail.url;
    },
    adminMenuItems() {
      let items = [];
      if(this.$store.getters.isUserEditor) {
        items.push({ title: "Edit", click: "rr:Edit" });        
        items.push({ title: "Find Release Thumbnail", click: "rr:FindCover" });
        items.push({ title: "Rescan", click: "rr:Rescan" });
      }
      if(this.$store.getters.isUserAdmin) {
        items.push({ title: "Delete", icon: "fa fa-trash-alt", class: "warning--text", click: "rr:Delete" });
        items.push({ title: "Delete (delete Files)", icon: "fa fa-trash-alt", class: "warning--text", click: "rr:DeleteFiles" });
        items.push({ title: "Merge Release", click: "rr:MergeReleases" });
      }      
      items.sort(function(a,b){
        const aTitle = a.title.toUpperCase();
        const bTitle = b.title.toUpperCase();
        return aTitle > bTitle ? 1 : -1;
      });      
      return items;
    },
    fileUploadUrl() {
      return process.env.VUE_APP_API_URL + "/uploadImage/" + this.release.id;
    },
    imageMenuItems() {
      let items = [];
      if(this.$store.getters.isUserEditor) {
        items.push({ title: 'Delete' });
      }      
      return items;
    },    
    userRating() {
      return (
        this.release.userRating || {
          isFavorite: false,
          isDisliked: false,
          rating: 0
        }
      );
    }
  },
  methods: {
    show (e) {
      e.preventDefault()
      this.selectedImageIndex = parseInt(e.currentTarget.attributes["data-id"].value);
      this.showImageMenu = false
      this.imageMenuX = e.clientX
      this.imageMenuY = e.clientY
      this.$nextTick(() => {
        this.showImageMenu = true
      })
    },       
    imageMenuClicked(e) {
      if(e === 0) {
        let releaseId = this.release.id;
        let selectedImageUrl = this.release.images[this.selectedImageIndex].url;
        this.$refs.confirm
          .open("Delete Release Image", "Are you sure?", { color: "red" })
          .then(confirm => {
            if (confirm) {
              let apiPath = process.env.VUE_APP_API_URL + "/admin/delete/releasesecondaryimage/" + releaseId + "/" + this.selectedImageIndex;
              if(!selectedImageUrl.includes('release-secondary')) {
                apiPath = process.env.VUE_APP_API_URL + "/images/delete/" + selectedImageUrl.split('/').pop();
              }
              this.$axios
                .post(apiPath)
                .then(() => {
                    this.updateData();
                });
            }
          });     
      }      
    },    
    dislikeTrackToggle: async function(toggleInfo) {
      this.$nextTick(() => {
        this.doUpdateIfNeeded = false;
        this.trackDislikeToggle({
          trackId: toggleInfo.trackId,
          isDisliked: toggleInfo.isDisliked
        });
      });
    },    
    favoriteTrackToggle: async function(toggleInfo) {      
      this.$nextTick(() => {
        this.doUpdateIfNeeded = false;
        this.trackFavoriteToggle({
          trackId: toggleInfo.trackId,
          isFavorite: toggleInfo.isFavorite
        });
      });
    },    
    doMerge() {
      this.$axios
        .post(
          process.env.VUE_APP_API_URL +
            "/releases/mergeReleases/" +
            this.release.id +
            "/" +
            this.selectedMergeRelease.value
        )
        .then(response => {
          if (!response.data.isSuccess) {
            EventBus.$emit("showSnackbar", {
              text: "An error has occured",
              color: "red"
            });
            return false;
          }
          this.showMergingRelease = false; 
          this.$router.push("/release/" + this.selectedMergeRelease.value);
        });
    },
    doMergeReleaseSearch: function(val) {
      if (this.searchReleasesLoading) {
        return;
      }
      this.searchReleasesLoading = true;
      this.$axios
        .get(
          process.env.VUE_APP_API_URL + "/releases?filter=" + val + "&limit=10"
        )
        .then(res => {
          this.lookupData.releaseItems = [];
          res.data.rows.forEach(a => {
            if (a.release.value != this.id) {
              this.lookupData.releaseItems.push({
                text: a.artist.text + ' - ' + a.release.text,
                value: a.release.value
              });
            }
          });
        })
        .catch(err => {
          EventBus.$emit("showSnackbar", {
            text: "An error has occured",
            color: "red",
            error: err
          });
        })
        .finally(() => (this.searchArtistsLoading = false));
    },
    mergeReleases: function() {
      this.showMergingRelease = true;
    },
    playNow: function() {
      this.$playQue.deleteAll()
      .then(() => {
        this.addToQue();
      });
    },
    addSelectedTrack: function(track) {
      if (
        !this.$_.find(this.selectedTracks, function(t) {
          return t.id === track.id;
        })
      ) {
        this.selectedTracks.push(track);
      }
    },
    removeSelectedTrack: function(track) {
      this.$_.remove(this.selectedTracks, function(t) {
        return t.id === track.id;
      });
    },
    coverDragUploadComplete: function() {
      this.coverSearchItems = [];
    },
    edit: function() {
      this.$router.push("/release/edit/" + this.release.id);
    },
    internetTitleSearch: function() {
      return this.internetSearch(this.searchQuery + " album");
    },
    internetArtistSearch: function() {
      return this.internetSearch(this.release.artist.artist.text + " Band");
    },
    searchInternetreleaseandTitle: function() {
      return this.internetSearch(
        this.searchQuery + " " + this.release.artist.artist.text
      );
    },
    internetSearch: function(q) {
      var url = "https://www.google.com/search?q=" + encodeURIComponent(q);
      window.open(url, "_blank");
    },
    searchForTitle: function() {
      this.$router.push({ name: "search", params: { q: 'r: ' + this.searchQuery } });
    },
    searchForArtist: function() {
      this.$router.push({
        name: "search",
        params: { q: 'a: ' + this.release.artist.artist.text }
      });
    },
    setRating: async function() {
      this.$nextTick(() => {
        this.releaseRatingChange({
          releaseId: this.release.id,
          newVal: this.userRating.rating
        }).then(this.updatePartial);
      });
    },    
    toggleFavorite: async function() {
      this.$nextTick(() => {
        this.releaseFavoriteToggle({
          releaseId: this.release.id,
          isFavorite: !this.userRating.isFavorite
        }).then(this.updatePartial);
      })
    },
    toggleHated: async function() {
      this.releaseDislikeToggle({
        releaseId: this.release.id,
        isDisliked: !this.userRating.isDisliked
      }).then(this.updatePartial);
    },
    addToQue: function() {
      let queTracks = [];
      let t = null;
      if (this.selectedTracks.length > 0) {
        t = this.selectedTracks;
      } else {
        t = this.$_.flatMap(this.release.medias, function(media) {
          return media.tracks;
        });
      }
      t.forEach(tr => {
        let artist = tr.trackArtist || this.release.artist;
        let queTrack = {
          id: tr.id,
          played: 0,
          mediaNumber: tr.mediaNumber,
          trackNumber: tr.trackNumber,
          title: tr.title,
          duration: tr.duration,
          durationTime: tr.durationTime,
          rating: tr.rating,
          playedCount: tr.playedCount,
          trackPlayUrl: tr.trackPlayUrl,
          release: {
            text: this.release.title,
            value: this.release.id,
            releaseDate: this.release.releaseDate
          },
          artist: artist,
          releaseArtist: this.release.artist,
          releaseImageUrl: this.release.thumbnail.url,
          artistImageUrl: artist.thumbnail.url,
          userRating: tr.userRating || { rating: 0 }
        };
        queTracks.push(queTrack); 
      });
      this.$playQue.add(queTracks)
      .then(function(result) {
        const message = result.message ||  "Added [" + result.addedCount + "] tracks to Que";
        EventBus.$emit("showSnackbar", { text: message });
      });
    },
    showImageModal: function(e) {
      this.modalImage = e;
      this.showModal = true;
    },
    selectedCoverImage: function(coverUrl) {
      this.coverSearchItems = [];
      EventBus.$emit("loadingStarted");
      this.$axios
        .post(
          process.env.VUE_APP_API_URL +
            "/releases/setImageByUrl/" +
            this.release.id +
            "/" +
            encodeURIComponent(coverUrl)
        )
        .then(response => {
          if (response.data.isSuccess) {
            EventBus.$emit("showSnackbar", {
              text: "Successfully updated Release cover."
            });
            this.$nextTick(() => {
              this.release.mediumThumbnail.url = response.data.data.url;
            });
          }
        })
        .finally(() => {
          EventBus.$emit("loadingComplete");
        });
    },
    findCover: async function() {
      if(this.loading) {
        return;
      }      
      EventBus.$emit("loadingStarted");
      this.coverSearchQuery =
        this.coverSearchQuery ||
        this.release.artist.artist.text + " " + this.release.title;
      this.$axios
        .post(
          process.env.VUE_APP_API_URL +
            "/images/search/release/" +
            encodeURIComponent(this.coverSearchQuery) +
            "/25"
        )
        .then(response => {
          this.coverSearchItems = response.data.data;
        })
        .finally(() => {
          EventBus.$emit("loadingComplete");
        });
    },
    rescan: async function() {
      EventBus.$emit("loadingStarted");
      this.$axios
        .post(
          process.env.VUE_APP_API_URL + "/admin/scan/release/" + this.release.id
        )
        .then(() => {
          this.updateData();
        });
    },
    delete: async function() {
      this.deleteAction(false);
    },
    deleteWithFiles: async function() {
      this.deleteAction(true);
    },
    deleteAction: async function(deleteFiles) {
      let releaseId = this.release.id;
      this.$refs.confirm
        .open("Delete", "Are you sure?", { color: "red" })
        .then(confirm => {
          if (confirm) {
            this.$axios
              .post(
                process.env.VUE_APP_API_URL +
                  "/admin/delete/release/" + releaseId + '?doDeleteFiles=' + deleteFiles
              )
              .then(() => {
                EventBus.$emit("loadingComplete");
                this.$router.go(-1);
              });
          }
        });
    },
    toggleBookmark: async function() {
      this.$axios
        .post(
          process.env.VUE_APP_API_URL +
            "/users/setReleaseBookmark/" +
            this.release.id +
            "/" +
            !this.release.userBookmarked
        )
        .then(response => {
          if (!this.release.userBookmarked) {
            EventBus.$emit("showSnackbar", { text: "Successfully bookmarked" });
          } else if (response.data.isSuccess) {
            EventBus.$emit("showSnackbar", {
              text: "Successfully removed bookmark"
            });
          }
          this.release.userBookmarked = !this.release.userBookmarked;
        })
        .finally(() => {
          EventBus.$emit("loadingComplete");
        });
    },
    updateIfNeeded: async function(info) {
      // If an user event happended and its related to this release then update release data
      if(!info || !this.doUpdateIfNeeded) {
        return;
      }
      if(info.artistId == this.release.artist.id || info.releaseId == this.id) {
        await this.updateData();
        return;
      }
      const releaseTracks = this.$_.flatMap(this.release.medias, function(media) {
        return media.tracks;
      });
      const trackOnThisRelease = this.$_.find(releaseTracks, function(t) {
        return t.id === info.trackId;
      })
      if(trackOnThisRelease) {
        await this.updateData();
      }
      this.doUpdateIfNeeded = true;
    },
    updatePartial: async function() {
      this.updateData(false);
    },
    updateComments: async function() {
      EventBus.$emit("loadingStarted");
      this.$axios
        .get(process.env.VUE_APP_API_URL + `/releases/${this.id}?inc=comments`)
        .then(response => {
          this.release.comments = response.data.data.comments || [];
        })
        .finally(() => {     
          this.$nextTick(() => {
            EventBus.$emit("loadingComplete");                
          });
        });           
    },    
    updateData: async function(isLoading) {
      this.loading = isLoading == undefined ? true : isLoading;
      this.coverSearchQuery = null;        
      EventBus.$emit("loadingStarted");
      this.releaseById(this.id)
      .then((response) => {
        this.release = response.release;      
      })
      .finally(() =>{
        this.dropzoneOptions.url =
          process.env.VUE_APP_API_URL +
          "/releases/uploadImage/" +
          this.release.id;
        this.dropzoneOptions.headers = {
          Authorization: "Bearer " + this.$store.getters.authToken
        };
        this.$nextTick(() => {
          this.loading = false;                    
          document.title = this.release.title;        
          EventBus.$emit("loadingComplete");          
          setTimeout(function() {
            var image = document.getElementById("releaseImage");
            window.favIcon.image(image);
          }, 500);
        });

      });
    },
    metaDataSources: function() {
      return [
        {
          source: "All Music",
          sourceId: this.release.amgId,
          url: "https://www.allmusic.com/artist/-"
        },
        {
          source: "Discogs",
          sourceId: this.release.discogsId,
          url: "https://www.discogs.com/artist/"
        },
        {
          source: "iTunes",
          sourceId: this.release.iTunesId,
          url: "https://itunes.apple.com/us/Release/"
        },
        {
          source: "MusicBrainz",
          sourceId: this.release.musicBrainzId,
          url: "https://musicbrainz.org/release/"
        },
        {
          source: "Spotify",
          sourceId: this.release.spotifyId,
          url: "https://play.spotify.com/Release/"
        }
      ];
    }
  },
  watch: {
    $route(to) {
      this.id = to.params.id;
      this.updateData();
    },
    coverSearchQuery: function() {
      if(!this.loading) {
        this.debouncedFindCover();
      }
    },
    searchForMergeRelease(val) {
      if (!val) {
        return;
      }
      this.debouncedMergeReleaseSearch(val);
    }
  },
  data: () => ({
    loading: true,
    showImageMenu: false,
    selectedImageIndex: null,
    imageMenuX: 0,
    imageMenuY: 0,    
    doUpdateIfNeeded: true,
    tab: 0,
    releaseTab: 2,
    selectedTracks: [],
    coverSearchQuery: "",
    showMergingRelease: false,
    searchReleasesLoading: false,
    selectedMergeRelease: null,
    searchForMergeRelease: null,
    showModal: false,
    modalImage: {},
    coverSearchItems: [],
    lookupData: {
      releaseItems: []
    },
    release: {
      status: 0,
      artist: {
        thumbnail: {},
        artist: {}
      },
      comments: [],      
      mediumThumbnail: {},
      userRating: {},
      statistics: {},
      images: [],
      medias: [],
      alternateNamesList: [],
      genres: [],
      collections: [],
      playlists: [],
      labels: [],
      tagsList: [],
      urLsList: []
    },
    metaDataHeaders: [
      {
        text: "Source",
        align: "left",
        sortable: false,
        value: "source"
      },
      {
        text: "Source Id",
        align: "left",
        sortable: false,
        value: "sourceId"
      }
    ],
    menuItems: [
      {
        title: "Add To Que",
        tooltip:
          "Added checked tracks to Que, if none selected adds all to Que.",
        class: "hidden-xs-only",
        click: "rr:AddToQue"
      },
      {
        title: "Play",
        tooltip: "Remove anything in Que and start Playing",
        click: "rr:PlayNow"
      }
    ],
    seachMenuItems: [
      { title: "Search for Artist",  click: "rr:searchForArtist" },
      { title: "Search for Title", click: "rr:searchForTitle" },
      { title: "Internet Artist", click: "rr:searchInternetArtist" },
      { title: "Internet Title", click: "rr:searchInternetTitle" },
      {
        title: "Internet Artist and Title",
        click: "rr:searchInternetreleaseandTitle"
      }
    ],
    dropzoneOptions: {
      thumbnailWidth: 100,
      maxFilesize: 5,
      dictDefaultMessage: "<i class='fa fa-cloud-upload'></i>Upload new Cover"
    }
  })
};
</script>


<style>
.release-detail-container .v-rating.release-rating {
  width: 100%;
}
.release-detail-container .profile {
  max-height: 350px;
  overflow: auto;
}
.release-detail-container .v-card__title {
  padding-top: 9px;
  padding-bottom: 9px;
}
.release-detail-container .images-container {
  max-height: 313px;
  overflow: hidden;
  overflow-y: auto;
}
.release-detail-container .release-lists .v-list {
  max-height: 300px;
  overflow: auto;
}
.release-detail-container .markdown-editor, .release-detail-container .comments .v-card { 
  max-width: 717px;
  margin-left: 17px;
}
.release-detail-container .comments .v-card { 
  max-width: 806px;
}
</style>
